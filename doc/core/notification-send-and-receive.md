# 通知发送和接收设计思路

### 使用的云服务技术
-  由于leancloud推送服务的目标使用用户是开发者，其里面的功能有诸多局限性，所以采用leancloud的实时通信服务。

### leancloud实时通信服务相关接口适配
- **用户 :** 由应用提供的clientId可以唯一标记一名用户，一台设备可以有多名用户同时使用，一个用户也可以同时登录多台设备，也可以限制一名用户只能登录一台设备。
- **推送 :** 当用户没有打开app时，采用实时通信服务的离线消息推送机制。当用户正在使用app时，待定。
- **对话 :**
  - 聊天室的对话是暂态的，并且没有离线消息通知的功能，所以不应采用聊天室聊天室对话的方案。多对多对话的方案复用性不高，因为每一次通知的对象基本都是不一样的。比较好的方法是建立一对一对话，首次需要发送通知的时候建立对话，之后复用这个对话。
  - 每一个对话由一个对话的id唯一标识，此对话id由云端自动创建，长时间不进行对话会导致对话被删除，可通过对话对象的getConversationId获取。
- **聊天记录 :**： 可设置缓存。

### 应用逻辑
- **通知发送基本流程 :**
  - 用户在注册登录之后，android应用获取到userId，作为clientId在leancloud云端来标识这个用户，通知收发均通过userId来标识。
  - 当发送方想要发送通知时，向服务器请求圈子列表和用户列表（待定），根据勾选的用户，一一创建或获取对话，发送通知，设置通知发送成功回调，通知发送成功之后，将通知内容持久化到android数据库上，并发送一份拷贝到服务端储存。
  - 当用户收到通知之后，也将通知内容持久化到android数据库上，当用户需要回复时，同理。
  - 在对话这个模式中，通知和回执本质上都属于消息。
  - 单聊对话也可以设置已读回调，可纳入app业务设计的考虑之中。

### 注意的细节
- **离线消息通知 :** *Android 聊天服务是和后台的推送服务共享连接的，所以只要有网络就永远在线，不需要专门做推送。消息达到后，你可以根据用户的设置来判断是否需要弹出通知。网络断开时，我们为每个对话保存 20 条离线消息。*
- **对话的有效期 :** *一个对话（包括普通、暂态、系统对话）如果 1 年内没有通过 SDK 或者 REST API 发送过新的消息，或者它在 _Conversation 表中的任意字段没有被更新过，即被视为不活跃对话，云端会自动将其删除。（查询对话的消息记录并不会更新 _Conversation 表，所以只查询不发送消息的对话仍会被视为不活跃对话。）不活跃的对话被删除后，当客户端再次通过 SDK 或 REST API 对其进行查询或发送消息时，会遇到 4401 INVALID_MESSAGING_TARGET 错误，表示该对话已经不存在了。同时，与该对话相关的消息历史也无法获取.*
